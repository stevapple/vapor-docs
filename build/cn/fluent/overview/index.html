


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://swiftclub.github.io/vapor-docs/fluent/overview/">
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.0">
    
    

<title>Vapor:  Fluent &rarr;  Overview</title>


    

      <link rel="stylesheet" href="../../assets/stylesheets/main.89dc9fe3.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecd4686e.min.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    

    


    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-76177358-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="blue">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fluent" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://swiftclub.github.io/vapor-docs" title="vapor-docs" class="md-header-nav__button md-logo" aria-label="vapor-docs">
      
  <img src="../../logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            vapor-docs
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Overview
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/swiftclub/vapor-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://swiftclub.github.io/vapor-docs" title="vapor-docs" class="md-nav__button md-logo" aria-label="vapor-docs">
      
  <img src="../../logo.png" alt="logo">

    </a>
    vapor-docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/swiftclub/vapor-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="序" class="md-nav__link">
      序
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      安装
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="安装" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        安装
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/macos/" title="macOS" class="md-nav__link">
      macOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/ubuntu/" title="Ubuntu" class="md-nav__link">
      Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      起步
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="起步" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        起步
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../hello-world/" title="Hello, world" class="md-nav__link">
      Hello, world
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../folder-structure/" title="Folder Structure" class="md-nav__link">
      Folder Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../spm/" title="SPM" class="md-nav__link">
      SPM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      入门
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="入门" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        入门
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../content/" title="Content" class="md-nav__link">
      Content
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../client/" title="Client" class="md-nav__link">
      Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../validation/" title="Validation" class="md-nav__link">
      Validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../async/" title="Async" class="md-nav__link">
      Async
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../environment/" title="Environment" class="md-nav__link">
      Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../errors/" title="Errors" class="md-nav__link">
      Errors
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Fluent
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Fluent" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Fluent
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Overview
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Overview" class="md-nav__link md-nav__link--active">
      Overview
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    配置（Configuration）
  </a>
  
    <nav class="md-nav" aria-label="配置（Configuration）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    现有项目
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    驱动
  </a>
  
    <nav class="md-nav" aria-label="驱动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgresql" class="md-nav__link">
    PostgreSQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlite" class="md-nav__link">
    SQLite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    MySQL
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    Models
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    标识符
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    字段
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    迁移
  </a>
  
    <nav class="md-nav" aria-label="迁移">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrate" class="md-nav__link">
    Migrate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    查询
  </a>
  
    <nav class="md-nav" aria-label="查询">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all" class="md-nav__link">
    All
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create" class="md-nav__link">
    Create
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    关系
  </a>
  
    <nav class="md-nav" aria-label="关系">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parent" class="md-nav__link">
    Parent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#children" class="md-nav__link">
    Children
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eager-load" class="md-nav__link">
    贪婪加载(Eager Load)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siblings" class="md-nav__link">
    Siblings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    生命周期
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timestamps" class="md-nav__link">
    Timestamps
  </a>
  
    <nav class="md-nav" aria-label="Timestamps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soft-delete" class="md-nav__link">
    Soft Delete
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    下一步
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../migrations/" title="Migrations" class="md-nav__link">
      Migrations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relations/" title="Relations" class="md-nav__link">
      Relations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../query-builder/" title="Query Builder" class="md-nav__link">
      Query Builder
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      进阶
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="进阶" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        进阶
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../middleware/" title="Middleware" class="md-nav__link">
      Middleware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../server/" title="Server" class="md-nav__link">
      Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../commands/" title="Commands" class="md-nav__link">
      Commands
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queues/" title="Queues" class="md-nav__link">
      Queues
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../websockets/" title="WebSockets" class="md-nav__link">
      WebSockets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../sessions/" title="Sessions" class="md-nav__link">
      Sessions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../services/" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      安全
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="安全" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        安全
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../passwords/" title="Passwords" class="md-nav__link">
      Passwords
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      部署
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="部署" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        部署
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/digital-ocean/" title="DigitalOcean" class="md-nav__link">
      DigitalOcean
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/supervisor/" title="Supervisor" class="md-nav__link">
      Supervisor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/nginx/" title="Nginx" class="md-nav__link">
      Nginx
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Version (4.0)
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Version (4.0)" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Version (4.0)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../version/1_5/" title="1.5" class="md-nav__link">
      1.5
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../version/2_0/" title="2.0" class="md-nav__link">
      2.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../version/3_0/" title="3.0" class="md-nav__link">
      3.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../version/4_0/" title="4.0" class="md-nav__link">
      4.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../upgrading/" title="Upgrading" class="md-nav__link">
      Upgrading
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    配置（Configuration）
  </a>
  
    <nav class="md-nav" aria-label="配置（Configuration）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    现有项目
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    驱动
  </a>
  
    <nav class="md-nav" aria-label="驱动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgresql" class="md-nav__link">
    PostgreSQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlite" class="md-nav__link">
    SQLite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    MySQL
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    Models
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    标识符
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    字段
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    迁移
  </a>
  
    <nav class="md-nav" aria-label="迁移">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrate" class="md-nav__link">
    Migrate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    查询
  </a>
  
    <nav class="md-nav" aria-label="查询">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all" class="md-nav__link">
    All
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create" class="md-nav__link">
    Create
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    关系
  </a>
  
    <nav class="md-nav" aria-label="关系">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parent" class="md-nav__link">
    Parent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#children" class="md-nav__link">
    Children
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eager-load" class="md-nav__link">
    贪婪加载(Eager Load)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siblings" class="md-nav__link">
    Siblings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    生命周期
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timestamps" class="md-nav__link">
    Timestamps
  </a>
  
    <nav class="md-nav" aria-label="Timestamps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soft-delete" class="md-nav__link">
    Soft Delete
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    下一步
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/swiftclub/vapor-docs/edit/master/docs/fluent/overview.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="fluent">Fluent<a class="headerlink" href="#fluent" title="Permanent link">&para;</a></h1>
<p>Fluent 是一个swift语言的 <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> 框架. 它利用swift强类型系统为你的数据库提供易用的接口. 使用Fluent的核心是创建用来表示数据库的数据结构的模型类型(Model). 然后使用这些模型执行创建、读取、更新、删除操作，而不是编写原始SQL语句。</p>
<h2 id="configuration">配置（Configuration）<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<p>当使用命令<code>vapor new</code>创建一个工程时, 键入 "yes" 来包含Fluent并选择你希望使用的数据库驱动。这将自动将依赖项以及示例配置代码添加到你的工程.</p>
<h3 id="_1">现有项目<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>如果你有一个现有项目想使用Fluent，则需要将两个依赖项添加到你的 <a href="../../spm/">package</a>:</p>
<ul>
<li><a href="https://github.com/vapor/fluent">vapor/fluent</a>@4.0.0</li>
<li>一个或多个Fluent驱动</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/vapor/fluent.git&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="s">&quot;4.0.0-beta&quot;</span><span class="p">),</span>
<span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/vapor/fluent-&lt;db&gt;-driver.git&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="p">&lt;</span><span class="n">version</span><span class="p">&gt;),</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;App&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;Fluent&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="s">&quot;fluent&quot;</span><span class="p">),</span> 
    <span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;Fluent&lt;db&gt;Driver&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="s">&quot;fluent-&lt;db&gt;-driver&quot;</span><span class="p">),</span> 
    <span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;Vapor&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">),</span>
<span class="p">]),</span>
</code></pre></div>


<p>一旦这些包被添加为依赖项，你就可以在<code>configure.swift</code>文件中，使用<code>app.databases</code>来配置你的数据库。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">Fluent</span>
<span class="kd">import</span> <span class="nc">Fluent</span><span class="p">&lt;</span><span class="nc">db</span><span class="p">&gt;</span><span class="nc">Driver</span>

<span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(&lt;</span><span class="n">db</span> <span class="n">config</span><span class="p">&gt;,</span> <span class="k">as</span><span class="p">:</span> <span class="p">&lt;</span><span class="n">identifier</span><span class="p">&gt;)</span>
</code></pre></div>


<p>下面是每一Fluent驱动程序的更详细的配置说明。</p>
<h3 id="_2">驱动<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>Fluent 当前有三个官方支持的驱动. 你可以在Github上搜索 <a href="https://github.com/topics/fluent-database"><code>fluent-driver</code></a> 来获取官方和第三方的Fluent数据库程序的完整列表。</p>
<h4 id="postgresql">PostgreSQL<a class="headerlink" href="#postgresql" title="Permanent link">&para;</a></h4>
<p>PostgreSQL 是一个开源的、符合标准的SQL数据库。它可以很容易的配置在大多数云托管提供商上. 这是 Fluent <strong>推荐的</strong> 数据库驱动.</p>
<p>要使用PostgreSQL, 需要添加下列依赖项到你的包中.</p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/vapor/fluent-postgres-driver.git&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="s">&quot;2.0.0-beta&quot;</span><span class="p">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;FluentPostgresDriver&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="s">&quot;fluent-postgres-driver&quot;</span><span class="p">)</span>
</code></pre></div>


<p>一旦添加了依赖项，你就可以在<code>configure.swift</code>文件中，使用<code>app.databases.use</code>来配置数据库凭证。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">Fluent</span>
<span class="kd">import</span> <span class="nc">FluentPostgresDriver</span>

<span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">postgres</span><span class="p">(</span><span class="n">hostname</span><span class="p">:</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">psql</span><span class="p">)</span>
</code></pre></div>


<p>你也可以从数据库连接字符串中解析凭证</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span> <span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">postgres</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;&lt;connection string&gt;&quot;</span><span class="p">),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">psql</span><span class="p">)</span>
</code></pre></div>


<h4 id="sqlite">SQLite<a class="headerlink" href="#sqlite" title="Permanent link">&para;</a></h4>
<p>SQLite是一个开源的嵌入式SQL数据库，其简单的特性使它成为原型和测试的卓越的候选。</p>
<p>要使用 SQLite, 需要添加下列依赖项到你的包中.</p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/vapor/fluent-sqlite-driver.git&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="s">&quot;4.0.0-beta&quot;</span><span class="p">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;FluentSQLiteDriver&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="s">&quot;fluent-sqlite-driver&quot;</span><span class="p">)</span>
</code></pre></div>


<p>一旦添加了依赖项，你就可以在<code>configure.swift</code>文件中，使用<code>app.databases.use</code>来配置数据库。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">Fluent</span>
<span class="kd">import</span> <span class="nc">FluentSQLiteDriver</span>

<span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">sqlite</span><span class="p">(.</span><span class="n">file</span><span class="p">(</span><span class="s">&quot;db.sqlite&quot;</span><span class="p">)),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">sqlite</span><span class="p">)</span>
</code></pre></div>


<p>你也可以配置SQLite将数据库临时存储在内存中。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">sqlite</span><span class="p">(.</span><span class="n">memory</span><span class="p">),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">sqlite</span><span class="p">)</span>
</code></pre></div>


<p>如果你使用内存数据库，请确保将Fluent设置为自动迁移(migration)，在添加迁移后，可以在命令行中使用参数<code>--auto-migrate</code>或者代码中运行<code>app.autoMigrate()</code>。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateTodo</span><span class="p">())</span>
<span class="k">try</span> <span class="n">app</span><span class="p">.</span><span class="n">autoMigrate</span><span class="p">().</span><span class="n">wait</span><span class="p">()</span>
</code></pre></div>


<h4 id="mysql">MySQL<a class="headerlink" href="#mysql" title="Permanent link">&para;</a></h4>
<p>MySQL是一个流行的开源数据库。它可以在大多数云托管提供商上获得.这个驱动也支持MariaDB.</p>
<p>要使用 MySQL, 需要添加下列依赖项到你的包中.</p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/vapor/fluent-mysql-driver.git&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="s">&quot;4.0.0-beta&quot;</span><span class="p">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;FluentMySQLDriver&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="s">&quot;fluent-mysql-driver&quot;</span><span class="p">)</span>
</code></pre></div>


<p>一旦添加了依赖项，你就可以在<code>configure.swift</code>文件中，使用<code>app.databases.use</code>来配置数据库凭证。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">Fluent</span>
<span class="kd">import</span> <span class="nc">FluentMySQLDriver</span>

<span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">mysql</span><span class="p">(</span><span class="n">hostname</span><span class="p">:</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="s">&quot;vapor&quot;</span><span class="p">),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">mysql</span><span class="p">)</span>
</code></pre></div>


<p>你也可以从数据库连接字符串中解析凭证.</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span> <span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">mysql</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="s">&quot;&lt;connection string&gt;&quot;</span><span class="p">),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">mysql</span><span class="p">)</span>
</code></pre></div>


<h2 id="models">Models<a class="headerlink" href="#models" title="Permanent link">&para;</a></h2>
<p>模型表示数据库中固定的数据结构，如表或集合。
模型有一个或多个存储可编码值的字段。
所有的模型都有唯一的标识符。
通过使用属性包装器来表示标识符和字段以及后面提到的更复杂的映射。
看看下面的模型，它代表了一个星系。</p>
<div class="codehilite"><pre><span></span><code><span class="kr">final</span> <span class="kd">class</span> <span class="nc">Galaxy</span><span class="p">:</span> <span class="n">Model</span> <span class="p">{</span>
    <span class="c1">// 表或集合的名称.</span>
    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">schema</span> <span class="p">=</span> <span class="s">&quot;galaxies&quot;</span>

    <span class="c1">// 唯一标识符.</span>
    <span class="p">@</span><span class="n">ID</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="p">.</span><span class="n">id</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span>

    <span class="c1">// The Galaxy&#39;s name.</span>
    <span class="p">@</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>

    <span class="c1">// 创建一个空的、新的 Galaxy.</span>
    <span class="kd">init</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="c1">// 通过所有属性集合创建一个新的 Galaxy.</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>要创建新的模型，请创建一个遵循<code>Model</code>协议的新类.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>建议标记模型类为<code>final</code>，以提高性能和简化一致性要求。</p>
</div>
<p><code>Model</code> 协议的第一个要求是静态属性<code>schema</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">static</span> <span class="kd">let</span> <span class="nv">schema</span> <span class="p">=</span> <span class="s">&quot;galaxies&quot;</span>
</code></pre></div>


<p>此属性告诉Fluent该模型对应的表或集合。此表可以是数据库中已经存在的表，也可以是你将使用<a href="#migration">migration</a>创建的. 它一般使用<code>snake_case</code>命名法且为复数.</p>
<h3 id="_3">标识符<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>下一个要求就是一个名为<code>id</code>的标识符字段。</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">ID</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span>
</code></pre></div>


<p>这个字段必须使用<code>@ID</code>属性包装器。Fluent推荐使用<code>UUID</code>和 专门的<code>.id</code>字段key，因为它兼容所有的Fluent驱动. </p>
<p>If you want to use a custom ID key or type, use the <code>@ID(custom:)</code> overload. 
如果要使用自定义的ID key或类型，请使用<code>@ID(custom:)</code>重载。</p>
<h3 id="_4">字段<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>在添加了标识符之后，你可以添加许多你想存储的信息的字段。在这个例子中，添加了一个字段作为星系的名称</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>
</code></pre></div>


<p>对于单个字段，使用<code>@Field</code>属性包装器。类似于<code>@ID</code>，<code>key</code>参数指定数据库中字段的名称。对于数据库字段命名的约定与swift中不同的情况，这一点特别有用。比如使用<code>snake_case</code>而不是<code>camelCase</code>。</p>
<p>下一步，所有的模型都要求一个空的初始化器，这允许Fluent来创建该模型的新实例。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">init</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div>


<p>最后，你可以为你的模型添加一个便利构造器，以设置它所有的属性。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">init</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
<span class="p">}</span>
</code></pre></div>


<p>使用便利构造器是非常有用的，当你添加新的字段到你的模型中，如果初始化方法发生变化，你可以获得编译时错误。迁移对于发送</p>
<h2 id="_5">迁移<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>如果数据库使用预定义schemas(如SQL 数据库),你需要一个迁移(migration)来为模型准备数据库。迁移对于数据库数据填充(seeding)也非常有用。要创建一个迁移，需要定义一个新的类型，遵循<code>Migration</code>协议。看看下面为先前定义的<code>Galaxy</code>模型的迁移。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">CreateGalaxy</span><span class="p">:</span> <span class="n">Migration</span> <span class="p">{</span>
    <span class="c1">// 准备用于存储Galaxy模型的数据库。</span>
    <span class="kd">func</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">id</span><span class="p">()</span>
            <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">string</span><span class="p">)</span>
            <span class="p">.</span><span class="n">create</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// 可选的恢复在准备方法中所作的修改。</span>
    <span class="kd">func</span> <span class="nf">revert</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">).</span><span class="n">delete</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p><code>prepare</code>方法用于准备存储<code>Galaxy</code>的数据库。</p>
<h3 id="schema">Schema<a class="headerlink" href="#schema" title="Permanent link">&para;</a></h3>
<p>在这个方法里, <code>database.schema(_:)</code> 用来创建一个新的 <code>SchemaBuilder</code>。 一个或多个 <code>field</code> 将被添加到这个builder，在调用 <code>create()</code>创建 schema之前.</p>
<p>添加到builder中的每一个字段都有一个名称，类型，和可选的约束。</p>
<div class="codehilite"><pre><span></span><code><span class="n">field</span><span class="p">(&lt;</span><span class="n">name</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="n">type</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="kr">optional</span> <span class="n">constraints</span><span class="p">&gt;)</span>
</code></pre></div>


<p>这里有个便利的<code>id()</code>方法，使用Fluent推荐的默认值，来添加<code>@ID</code>属性，</p>
<p>还原迁移可以撤销在prepare方法中所作的任何更改，在本例中，只是删除Galaxy模型的schema。</p>
<p>一旦定义了迁移，你需要在<code>configure.swift</code>文件中，将它添加进<code>app.migrations</code>，来告诉Fluent。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateGalaxy</span><span class="p">())</span>
</code></pre></div>


<h3 id="migrate">Migrate<a class="headerlink" href="#migrate" title="Permanent link">&para;</a></h3>
<p>要执行迁移，在命令行中调用<code>vapor run migrate</code> 或者添加<code>migrate</code>作为Xcode运行方案的一个参数。</p>
<div class="codehilite"><pre><span></span><code>$ vapor run migrate
Migrate Command: Prepare
The following migration(s) will be prepared:
+ CreateGalaxy on default
Would you like to continue?
y/n&gt; y
Migration successful
</code></pre></div>


<h2 id="_6">查询<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>现在你已经成功的创建了一个模型，并且迁移到了数据库，你可以进行第一次查询了。</p>
<h3 id="all">All<a class="headerlink" href="#all" title="Permanent link">&para;</a></h3>
<p>下面的路由，它将会返回数据库中包含所有星系的一个数组。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="k">in</span>
    <span class="n">Galaxy</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">).</span><span class="n">all</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>


<p>为了直接在路由的闭包中直接返回Galaxy,需要它遵循<code>Content</code>协议。</p>
<div class="codehilite"><pre><span></span><code><span class="kr">final</span> <span class="kd">class</span> <span class="nc">Galaxy</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Content</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>


<p><code>Galaxy.query</code> 为模型创建一个新的查询构建器. <code>req.db</code> 是对应用程序默认数据库的引用. 最终, <code>all()</code> 返回存储在数据库中的所有模型。</p>
<p>编译并运行项目，并且请求<code>GET /galaxies</code>，你应该看到返回了一个空数组。让我们添加一条创建星系的路由。</p>
<h3 id="create">Create<a class="headerlink" href="#create" title="Permanent link">&para;</a></h3>
<p>根据RESTful风格, 使用 <code>POST /galaxies</code> 创建一个星系. 因为模型是可编码的，所以你可以直接从请求体中解码星系。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="n">Galaxy</span><span class="p">&gt;</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="nv">galaxy</span> <span class="p">=</span> <span class="k">try</span> <span class="n">req</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">Galaxy</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">galaxy</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">galaxy</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<div class="admonition seealso">
<p class="admonition-title">Seealso</p>
<p>有关请求体解码的更多信息请参阅 <a href="../../content/">Content &rarr; Overview</a>.</p>
</div>
<p>一旦你有了model的实例，调用<code>create(on:)</code>将模型保存到数据库。这返回一个<code>EventLoopFuture&lt;Void&gt;</code>，它指示保存已经完成。保存完成后，使用<code>map</code>返回新创建的模型</p>
<p>编译并运行项目，并且发送下面的请求。</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/galaxies</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">content-length</span><span class="o">:</span> <span class="l">21</span>
<span class="na">content-type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Milky Way&quot;</span>
<span class="p">}</span>
</code></pre></div>


<p>你应该获得下面的响应，带有id标识符的新建模型。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Milky Way&quot;</span>
<span class="p">}</span>
</code></pre></div>


<p>现在，如果你再次查询 <code>GET /galaxies</code>，你应该看到新建的星系在数组中。</p>
<h2 id="_7">关系<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>没有星星的星系！让我们通过在<code>Galaxy</code>和一个新的<code>Star</code>模型之间添加一对多关系，来快速查看Fluent强大的关系特性。</p>
<div class="codehilite"><pre><span></span><code><span class="kr">final</span> <span class="kd">class</span> <span class="nc">Star</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Content</span> <span class="p">{</span>
    <span class="c1">// 表或集合的名称</span>
    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">schema</span> <span class="p">=</span> <span class="s">&quot;stars&quot;</span>

    <span class="c1">// Star的唯一标识符.</span>
    <span class="p">@</span><span class="n">ID</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="p">.</span><span class="n">id</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span>

    <span class="c1">// Star的名称.</span>
    <span class="p">@</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>

    <span class="c1">// 建立关系，星星在星系中</span>
    <span class="p">@</span><span class="n">Parent</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;galaxy_id&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">galaxy</span><span class="p">:</span> <span class="n">Galaxy</span>

    <span class="c1">// Creates a new, empty Star.</span>
    <span class="kd">init</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="c1">// Creates a new Star with all properties set.</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">galaxyID</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
        <span class="kc">self</span><span class="p">.</span><span class="err">$</span><span class="n">galaxy</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">galaxyID</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3 id="parent">Parent<a class="headerlink" href="#parent" title="Permanent link">&para;</a></h3>
<p>新的<code>Star</code>模型与<code>Galaxy</code>非常相似，除了一个新的字段类型：<code>@Parent</code>。</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">Parent</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;galaxy_id&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">galaxy</span><span class="p">:</span> <span class="n">Galaxy</span>
</code></pre></div>


<p>perent属性是一个存储另外一个模型标识符的字段。保存关系的模型成为"子"，引用的模型称为“父”。这种类型的关系也被称为“一对多”。<code>key</code>属性指定应用于数据库中存储父键的字段名。</p>
<p>在初始化方法中，父标识符通过<code>$galaxy</code>设置。</p>
<div class="codehilite"><pre><span></span><code><span class="kc">self</span><span class="p">.</span><span class="err">$</span><span class="n">galaxy</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">galaxyID</span>
</code></pre></div>


<p>通过在父属性的名称使用<code>$</code>前缀，你可以访问底层的属性包装器。这是需要访问内部的<code>@Field</code>，来存储实际的标识符值。</p>
<div class="admonition seealso">
<p class="admonition-title">Seealso</p>
<p>查看有关属性包装器的swift演进建议以获取更多信息: <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0258-property-wrappers.md">[SE-0258] Property Wrappers</a></p>
</div>
<p>接下来，创建一个迁移来准备数据库处理<code>Star</code>。</p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">CreateStar</span><span class="p">:</span> <span class="n">Migration</span> <span class="p">{</span>
    <span class="c1">// Prepares the database for storing Star models.</span>
    <span class="kd">func</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;stars&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">id</span><span class="p">()</span>
            <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">string</span><span class="p">)</span>
            <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;galaxy_id&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">.</span><span class="n">references</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">))</span>
            <span class="p">.</span><span class="n">create</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Optionally reverts the changes made in the prepare method.</span>
    <span class="kd">func</span> <span class="nf">revert</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;stars&quot;</span><span class="p">).</span><span class="n">delete</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>这大部分是与Galaxy的迁移一样的，除了增加了个字段来存储父星系的标识符。</p>
<div class="codehilite"><pre><span></span><code><span class="n">field</span><span class="p">(</span><span class="s">&quot;galaxy_id&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">.</span><span class="n">references</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">))</span>
</code></pre></div>


<p>这个字段指定了一个可选的约束，告知数据库这个字段的值，引用“galaxies”schema中的“id”字段。这也可以称为外键，有助于确保数据的完整性。</p>
<p>一旦创建了迁移，把它添加到<code>app.migrations</code>，并在<code>CreateGalaxy</code>迁移的后面。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateGalaxy</span><span class="p">())</span>
<span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateStar</span><span class="p">())</span>
</code></pre></div>


<p>由于迁移是有序运行的，<code>CreateStar</code>引用了galaxies schema，所以排序很重要。最终，
Since migrations run in order, and <code>CreateStar</code> references the galaxies schema, ordering is important. Finally, <a href="#migrate">运行迁移</a> 来准备数据库.</p>
<p>添加一个路由来创建新的星星。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;stars&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="n">Star</span><span class="p">&gt;</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="nv">star</span> <span class="p">=</span> <span class="k">try</span> <span class="n">req</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">Star</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">star</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">star</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>使用以下HTTP请求创建引用先前创建的星系的新星星。</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/stars</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">content-length</span><span class="o">:</span> <span class="l">36</span>
<span class="na">content-type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sun&quot;</span><span class="p">,</span>
    <span class="nt">&quot;galaxy&quot;</span><span class="p">:</span> <span class="p">{</span> 
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span> 
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>你应该看到返回了一个带有唯一标识符的新星星。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sun&quot;</span><span class="p">,</span>
    <span class="nt">&quot;galaxy&quot;</span><span class="p">:</span> <span class="p">{</span> 
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3 id="children">Children<a class="headerlink" href="#children" title="Permanent link">&para;</a></h3>
<p>现在，让我们来看看如何利用Fluent的贪婪加载（eager-loading）特性，在<code>GET /galaxies</code>路由中自动返回星系中的星星。
添加下面属性到<code>Galaxy</code>模型。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Galaxy所有的Star.</span>
<span class="p">@</span><span class="n">Children</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">galaxy</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">stars</span><span class="p">:</span> <span class="p">[</span><span class="n">Star</span><span class="p">]</span>
</code></pre></div>


<p><code>@Children</code>属性包装器和<code>@Parent</code>相反。它需要一个键路径到子模型的<code>@Parent</code>字段作为<code>for</code>参数。它的值是一个子模型的数组，因为可能存在0个或多个子模型。Galaxy的迁移不需要做任何修改，因为这种关系所需的所有信息都存储在子模型<code>Star</code>上。</p>
<h3 id="eager-load">贪婪加载(Eager Load)<a class="headerlink" href="#eager-load" title="Permanent link">&para;</a></h3>
<p>现在关系已经完成了，你可以使用<code>with</code>方法来自动获取和序列化星系-星的关系。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;galaxies&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="k">in</span>
    <span class="n">Galaxy</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">).</span><span class="n">with</span><span class="p">(</span><span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">stars</span><span class="p">).</span><span class="n">all</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>


<p><code>@Children</code>关系的键路径被传递给<code>with</code>，告诉Fluent在所有生成的模型中自动加载此关系。运行项目，并发起请求<code>GET /galaxies</code>。你会看到所有的星已经自动包含在响应中。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span><span class="p">,</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Milky Way&quot;</span><span class="p">,</span>
        <span class="nt">&quot;stars&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span><span class="p">,</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sun&quot;</span><span class="p">,</span>
                <span class="nt">&quot;galaxy&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="err">...</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>


<h3 id="siblings">Siblings<a class="headerlink" href="#siblings" title="Permanent link">&para;</a></h3>
<p>最后一种关系是多对多，或称为兄弟关系。创建一个<code>Tag</code>模型，包含<code>id</code>和<code>name</code>字段，我们将用它来标记具有某些特征的星。</p>
<div class="codehilite"><pre><span></span><code><span class="kr">final</span> <span class="kd">class</span> <span class="nc">Tag</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Content</span> <span class="p">{</span>
    <span class="c1">// Name of the table or collection.</span>
    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">schema</span><span class="p">:</span> <span class="nb">String</span> <span class="p">=</span> <span class="s">&quot;tags&quot;</span>

    <span class="c1">// Unique identifier for this Tag.</span>
    <span class="p">@</span><span class="n">ID</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="p">.</span><span class="n">id</span><span class="p">)</span> 
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span>

    <span class="c1">// The Tag&#39;s name.</span>
    <span class="p">@</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;name&quot;</span><span class="p">)</span> 
    <span class="kd">var</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>

    <span class="c1">// Creates a new, empty Tag.</span>
    <span class="kd">init</span><span class="p">()</span> <span class="p">{}</span>

    <span class="c1">// Creates a new Tag with all properties set.</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>一个标签可以有很多星，一个星可以有很多标签，它们是兄弟关系。两个模型之间的兄弟关系需要第三个模型（称之为pivot）来保存关系数据。每一个<code>StarTag</code>模型对象表示单个的星对标签的关系，持有一个<code>Star</code>和<code>Tag</code>的id。</p>
<div class="codehilite"><pre><span></span><code><span class="kr">final</span> <span class="kd">class</span> <span class="nc">StarTag</span><span class="p">:</span> <span class="n">Model</span> <span class="p">{</span>
    <span class="c1">// Name of the table or collection.</span>
    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">schema</span><span class="p">:</span> <span class="nb">String</span> <span class="p">=</span> <span class="s">&quot;star_tag&quot;</span>

    <span class="c1">// Unique identifier for this pivot.</span>
    <span class="p">@</span><span class="n">ID</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="p">.</span><span class="n">id</span><span class="p">)</span> 
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span>

    <span class="c1">// Reference to the Tag this pivot relates.</span>
    <span class="p">@</span><span class="n">Parent</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;tag_id&quot;</span><span class="p">)</span> 
    <span class="kd">var</span> <span class="nv">tag</span><span class="p">:</span> <span class="n">Tag</span>

    <span class="c1">// Reference to the Star this pivot relates.</span>
    <span class="p">@</span><span class="n">Parent</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;star_id&quot;</span><span class="p">)</span> 
    <span class="kd">var</span> <span class="nv">star</span><span class="p">:</span> <span class="n">Star</span>

    <span class="c1">// Creates a new, empty pivot.</span>
    <span class="kd">init</span><span class="p">()</span> <span class="p">{}</span>

    <span class="c1">// Creates a new pivot with all properties set.</span>
    <span class="kd">init</span><span class="p">(</span><span class="n">tagID</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">starID</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="err">$</span><span class="n">tag</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">tagID</span>
        <span class="kc">self</span><span class="p">.</span><span class="err">$</span><span class="n">star</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">starID</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>


<p>现在，让我们更新新的<code>Tag</code>模型，在其中添加一个<code>stars</code>属性，表示这个标签下的所有星星。</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">Siblings</span><span class="p">(</span><span class="n">through</span><span class="p">:</span> <span class="n">StarTag</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">tag</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">star</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">stars</span><span class="p">:</span> <span class="p">[</span><span class="n">Star</span><span class="p">]</span>
</code></pre></div>


<p><code>@Siblings</code>属性包装器需要三个参数。第一个参数是先前创建的pivot模型<code>StarTag</code>。接下来的两个参数是pivot模型父关系的键路径。
<code>from</code>键路径是pivot模型与当前模型的父关系，在这里是<code>Tag</code>。<code>to</code>键路径是pivot模型与另一个相关模型的父关系，在这里是<code>Star</code>。
这三个参数结合在一起，形成一个关系：从当前的模型<code>Tag</code>，穿过pivot模型<code>StarTag</code>，到所期望的模型<code>Star</code>。
现在让我们更新<code>Star</code>模型，来创建一条和上面相反的路线的关系:</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">Siblings</span><span class="p">(</span><span class="n">through</span><span class="p">:</span> <span class="n">StarTag</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">star</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">tag</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">Tag</span><span class="p">]</span>
</code></pre></div>


<p>这些兄弟关系属性依赖于<code>StarTag</code>存储，所以我们不需要更新<code>Star</code>迁移，但是我们需要为<code>Tag</code>和<code>StarTag</code>创建迁移:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">CreateTag</span><span class="p">:</span> <span class="n">Migration</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;tags&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">id</span><span class="p">()</span>
            <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">string</span><span class="p">)</span>
            <span class="p">.</span><span class="n">create</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">revert</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;tags&quot;</span><span class="p">).</span><span class="n">delete</span><span class="p">()</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">CreateStarTag</span><span class="p">:</span> <span class="n">Migration</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;star_tag&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">id</span><span class="p">()</span>
            <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;star_id&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">.</span><span class="kr">required</span><span class="p">,</span> <span class="p">.</span><span class="n">references</span><span class="p">(</span><span class="s">&quot;star&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">))</span>
            <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;tag_id&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">.</span><span class="kr">required</span><span class="p">,</span> <span class="p">.</span><span class="n">references</span><span class="p">(</span><span class="s">&quot;star&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">))</span>
            <span class="p">.</span><span class="n">create</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">revert</span><span class="p">(</span><span class="n">on</span> <span class="n">database</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="s">&quot;star_tag&quot;</span><span class="p">).</span><span class="n">delete</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>然后在configure.swift中添加迁移:</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateTag</span><span class="p">())</span>
<span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateStarTag</span><span class="p">())</span>
</code></pre></div>


<p>现在我们想给星加标签，创建一个路由用来创建一个新的标签，之后我们需要创建将标签添加到星的路由。</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;star&quot;</span><span class="p">,</span> <span class="s">&quot;:starID&quot;</span><span class="p">,</span> <span class="s">&quot;tag&quot;</span><span class="p">,</span> <span class="s">&quot;:tagID&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="n">HTTPStatus</span><span class="p">&gt;</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="nv">star</span> <span class="p">=</span> <span class="n">Star</span><span class="p">.</span><span class="bp">find</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;starID&quot;</span><span class="p">),</span> <span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">)</span>
        <span class="p">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">or</span><span class="p">:</span> <span class="n">Abort</span><span class="p">(.</span><span class="n">notFound</span><span class="p">))</span>
    <span class="kd">let</span> <span class="nv">tag</span> <span class="p">=</span> <span class="n">Tag</span><span class="p">.</span><span class="bp">find</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;tagID&quot;</span><span class="p">),</span> <span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">)</span>
        <span class="p">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">or</span><span class="p">:</span> <span class="n">Abort</span><span class="p">(.</span><span class="n">notFound</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">star</span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">tag</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">in</span>
        <span class="n">star</span><span class="p">.</span><span class="err">$</span><span class="n">tags</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">)</span>
    <span class="p">}.</span><span class="n">transform</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">.</span><span class="n">ok</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>


<p>这个路由包含了星和标签的id参数组件，我们希望彼此关联。
如果我们想要在id为1的星和id为2的标签之间建立关系，我们需要发送<strong>POST</strong>请求到<code>/star/1/tag/2</code>，且我们会收到一个Http响应码。
首先，我们需要在数据库中查找星和标签，以确保这些id是有效的。
然后，我们通过把这个id为2的标签，附加到id为1的星的所有标签里来创建这个关系。
由于星的属性是一个与另外模型的关系，所以我们需要使用<code>$</code>操作符，来访问它的属性包装器<code>@Siblings</code>。</p>
<p>在默认情况下不获取兄弟关系，如果我们希望包含它们，在查询的时候需要插入<code>with</code>方法。所以我们需要更新获取所有星的路由:</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;stars&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="k">in</span>
    <span class="n">Star</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">).</span><span class="n">with</span><span class="p">(</span><span class="err">\</span><span class="p">.</span><span class="err">$</span><span class="n">tags</span><span class="p">).</span><span class="n">all</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>


<h2 id="_8">生命周期<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>要创建响应<code>Model</code>上的事件钩子，你可以为你的模型创建中间件，你的中间件必须遵循<code>ModelMiddleware</code>协议.</p>
<p>这里一个简单的中间件示例:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">GalaxyMiddleware</span><span class="p">:</span> <span class="n">ModelMiddleware</span> <span class="p">{</span>
    <span class="c1">// 当模型被创建时执行。</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Galaxy</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 当模型更新时执行</span>
    <span class="kd">func</span> <span class="nf">update</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Galaxy</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 当模型软删除时执行</span>
    <span class="kd">func</span> <span class="nf">softDelete</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Galaxy</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">softDelete</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 当还原软删除模型的时执行</span>
    <span class="kd">func</span> <span class="nf">restore</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Galaxy</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">restore</span><span class="p">(</span><span class="n">model</span> <span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 当模型删除时候执行。</span>
    <span class="c1">// 如果&quot;force&quot; 参数为true, 模型将被永久删除。 </span>
    <span class="c1">// 即使使用软删除时间戳.</span>
    <span class="kd">func</span> <span class="nf">delete</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Galaxy</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="n">force</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>这些方法中的每一个都有一个默认的实现，所以您只需要包含您需要的方法。
你应该返回下一个<code>AnyModelResponder</code>相应的方法，Fluent继续处理事件。</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>此中间件只响应这些函数中提供的<code>Model</code>类型的生命周期事件。在上面的例子中，<code>GalaxyMiddleware</code>在Galaxy模型上响应事件。</p>
</div>
<p>使用这些方法，你可以在事件完成之前和之后执行操作。在事件完成后执行操作，可以使用.flatMap() 在从下一个响应中返回的future中执行.例如：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">GalaxyMiddleware</span><span class="p">:</span> <span class="n">ModelMiddleware</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Galaxy</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>

        <span class="c1">// 在创建模型之前，可以在这里修改模型。</span>
        <span class="n">model</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;&lt;New Galaxy Name&gt;&quot;</span>

        <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span>
            <span class="c1">// 一旦创建完成, 这里的代码会被执行</span>
            <span class="bp">print</span> <span class="p">(</span><span class="s">&quot;Galaxy </span><span class="si">\(</span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="si">)</span><span class="s"> was created&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>一旦你创建了中间件，你必须将它注册在<code>Application</code>的数据库中间件配置中，在<code>configure.swift</code>文件中添加:</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">middleware</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">GalaxyMiddleware</span><span class="p">(),</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">psql</span><span class="p">)</span>
</code></pre></div>


<h2 id="timestamps">Timestamps<a class="headerlink" href="#timestamps" title="Permanent link">&para;</a></h2>
<p>Fluent通过在模型中指定<code>Timestamp</code>字段来跟踪模型上的创建和更新时间。
当需要时，Fluent自动设置字段。你可以这样添加：</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">create</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">createdAt</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>

<span class="p">@</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;updated_at&quot;</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">update</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">updatedAt</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</code></pre></div>


<div class="admonition info">
<p class="admonition-title">Info</p>
<p>您可以为这些字段使用任何名称/键. <code>created_at</code> / <code>updated_at</code>, 只是为了说明目的。</p>
</div>
<p>在迁移中添加时间戳字段使用<code>.datetime</code>类型。</p>
<div class="codehilite"><pre><span></span><code><span class="n">database</span><span class="p">.</span><span class="n">schema</span><span class="p">(...)</span>
    <span class="p">...</span>
    <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;created_at&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="s">&quot;updated_at&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="p">.</span><span class="n">create</span><span class="p">()</span>
</code></pre></div>


<h3 id="soft-delete">Soft Delete<a class="headerlink" href="#soft-delete" title="Permanent link">&para;</a></h3>
<p>软删除在数据库将项目标记为已删除，但实际上并没有删除它。
当你有数据保留需求时，这可能是有用的。
在Fluent中，它通过设置一个删除时间戳来工作。
默认情况下，软删除项不会出现在查询中，并且可以随时恢复。</p>
<p>Soft deletion marks an item as deleted in the database but doesn't actually remove it. This can be useful when you have data retention requirements, for example. In Fluent, it works by setting a deletion timestamp. By default, soft deleted items won't appear in queries and can be restored at any time.</p>
<p>类似于创建和更新时间戳，要在模型中启用软删除，只需要将删除时间戳设置为<code>.delete</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;deleted_at&quot;</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">delete</span><span class="p">)</span>
<span class="kd">var</span> <span class="nv">deletedAt</span><span class="p">:</span> <span class="n">Date</span><span class="p">?</span>
</code></pre></div>


<p>调用<code>Model.delete(on:)</code>删除具有删除时间戳属性的模型，将自动软删除它。</p>
<p>如果你需要执行一个查询，包含软删除的项目，你可以在查询中使用<code>withDeleted()</code></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Get all galaxies including soft-deleted ones.</span>
<span class="n">Galaxy</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">).</span><span class="n">withDeleted</span><span class="p">().</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>


<p>你可以用<code>restore(on:)</code>方法还原软删除的模型:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Restore galaxy</span>
<span class="n">galaxy</span><span class="p">.</span><span class="n">restore</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
</code></pre></div>


<p>若要永久删除带有删除时间戳的项，请使用“force”参数:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Permanently delete</span>
<span class="n">galaxy</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">force</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
</code></pre></div>


<h2 id="_9">下一步<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>祝贺您创建了第一个模型和迁移，并执行基本的创建和读取操作。
有关所有这些特性的更多深入信息，请参阅Fluent指南中各自的章节。</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../errors/" title="Errors" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Errors
              </div>
            </div>
          </a>
        
        
          <a href="../models/" title="Models" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Models
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.36cbf620.min.js"></script>
      <script src="../../assets/javascripts/bundle.00c583dd.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.7f7c8775.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>