


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://swiftclub.github.io/vapor-docs/upgrading/">
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.0">
    
    

<title>Vapor:  Version (4.0) &rarr;  Upgrading</title>


    

      <link rel="stylesheet" href="../assets/stylesheets/main.89dc9fe3.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecd4686e.min.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    

    


    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-76177358-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="blue">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#upgrading-to-40" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://swiftclub.github.io/vapor-docs" title="vapor-docs" class="md-header-nav__button md-logo" aria-label="vapor-docs">
      
  <img src="../logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            vapor-docs
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Upgrading
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/swiftclub/vapor-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://swiftclub.github.io/vapor-docs" title="vapor-docs" class="md-nav__button md-logo" aria-label="vapor-docs">
      
  <img src="../logo.png" alt="logo">

    </a>
    vapor-docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/swiftclub/vapor-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="序" class="md-nav__link">
      序
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      安装
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="安装" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        安装
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../install/macos/" title="macOS" class="md-nav__link">
      macOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install/ubuntu/" title="Ubuntu" class="md-nav__link">
      Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      起步
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="起步" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        起步
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../hello-world/" title="Hello, world" class="md-nav__link">
      Hello, world
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../folder-structure/" title="Folder Structure" class="md-nav__link">
      Folder Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../spm/" title="SPM" class="md-nav__link">
      SPM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      入门
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="入门" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        入门
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../content/" title="Content" class="md-nav__link">
      Content
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../client/" title="Client" class="md-nav__link">
      Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../validation/" title="Validation" class="md-nav__link">
      Validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../async/" title="Async" class="md-nav__link">
      Async
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../environment/" title="Environment" class="md-nav__link">
      Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../errors/" title="Errors" class="md-nav__link">
      Errors
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Fluent
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Fluent" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Fluent
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../fluent/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fluent/models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fluent/migrations/" title="Migrations" class="md-nav__link">
      Migrations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fluent/relations/" title="Relations" class="md-nav__link">
      Relations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fluent/query-builder/" title="Query Builder" class="md-nav__link">
      Query Builder
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      进阶
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="进阶" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        进阶
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../middleware/" title="Middleware" class="md-nav__link">
      Middleware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server/" title="Server" class="md-nav__link">
      Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../commands/" title="Commands" class="md-nav__link">
      Commands
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../queues/" title="Queues" class="md-nav__link">
      Queues
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../websockets/" title="WebSockets" class="md-nav__link">
      WebSockets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../sessions/" title="Sessions" class="md-nav__link">
      Sessions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../services/" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      安全
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="安全" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        安全
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../passwords/" title="Passwords" class="md-nav__link">
      Passwords
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      部署
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="部署" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        部署
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../deploy/digital-ocean/" title="DigitalOcean" class="md-nav__link">
      DigitalOcean
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deploy/supervisor/" title="Supervisor" class="md-nav__link">
      Supervisor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deploy/nginx/" title="Nginx" class="md-nav__link">
      Nginx
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9" checked>
    
    <label class="md-nav__link" for="nav-9">
      Version (4.0)
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Version (4.0)" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Version (4.0)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../version/1_5/" title="1.5" class="md-nav__link">
      1.5
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../version/2_0/" title="2.0" class="md-nav__link">
      2.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../version/3_0/" title="3.0" class="md-nav__link">
      3.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../version/4_0/" title="4.0" class="md-nav__link">
      4.0
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Upgrading
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Upgrading" class="md-nav__link md-nav__link--active">
      Upgrading
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packageswift" class="md-nav__link">
    Package.swift
  </a>
  
    <nav class="md-nav" aria-label="Package.swift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#old-packages" class="md-nav__link">
    Old Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fluent" class="md-nav__link">
    Fluent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platforms" class="md-nav__link">
    Platforms
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xcode" class="md-nav__link">
    Xcode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    Run
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app" class="md-nav__link">
    App
  </a>
  
    <nav class="md-nav" aria-label="App">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configureswift" class="md-nav__link">
    configure.swift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootswift" class="md-nav__link">
    boot.swift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routesswift" class="md-nav__link">
    routes.swift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#providers" class="md-nav__link">
    Providers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment" class="md-nav__link">
    Environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-services" class="md-nav__link">
    Custom Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-providers" class="md-nav__link">
    Custom Providers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nio" class="md-nav__link">
    NIO
  </a>
  
    <nav class="md-nav" aria-label="NIO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async-naming-changes" class="md-nav__link">
    Async naming changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bytebuffer" class="md-nav__link">
    ByteBuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throwing-map-flatmap" class="md-nav__link">
    Throwing map / flatMap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#routing" class="md-nav__link">
    Routing
  </a>
  
    <nav class="md-nav" aria-label="Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-content" class="md-nav__link">
    Synchronous Content
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comma-separated-paths" class="md-nav__link">
    Comma-separated paths
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#route-parameters" class="md-nav__link">
    Route parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middleware" class="md-nav__link">
    Middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http" class="md-nav__link">
    HTTP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket" class="md-nav__link">
    WebSocket
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fluent_1" class="md-nav__link">
    Fluent
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crypto" class="md-nav__link">
    Crypto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queues" class="md-nav__link">
    Queues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validation" class="md-nav__link">
    Validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auth" class="md-nav__link">
    Auth
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stripe" class="md-nav__link">
    Stripe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mailgun" class="md-nav__link">
    Mailgun
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leaf" class="md-nav__link">
    Leaf
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#packageswift" class="md-nav__link">
    Package.swift
  </a>
  
    <nav class="md-nav" aria-label="Package.swift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#old-packages" class="md-nav__link">
    Old Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fluent" class="md-nav__link">
    Fluent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platforms" class="md-nav__link">
    Platforms
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xcode" class="md-nav__link">
    Xcode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    Run
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app" class="md-nav__link">
    App
  </a>
  
    <nav class="md-nav" aria-label="App">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configureswift" class="md-nav__link">
    configure.swift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootswift" class="md-nav__link">
    boot.swift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routesswift" class="md-nav__link">
    routes.swift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#providers" class="md-nav__link">
    Providers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment" class="md-nav__link">
    Environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-services" class="md-nav__link">
    Custom Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-providers" class="md-nav__link">
    Custom Providers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nio" class="md-nav__link">
    NIO
  </a>
  
    <nav class="md-nav" aria-label="NIO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#async-naming-changes" class="md-nav__link">
    Async naming changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bytebuffer" class="md-nav__link">
    ByteBuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throwing-map-flatmap" class="md-nav__link">
    Throwing map / flatMap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#routing" class="md-nav__link">
    Routing
  </a>
  
    <nav class="md-nav" aria-label="Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-content" class="md-nav__link">
    Synchronous Content
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comma-separated-paths" class="md-nav__link">
    Comma-separated paths
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#route-parameters" class="md-nav__link">
    Route parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middleware" class="md-nav__link">
    Middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http" class="md-nav__link">
    HTTP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket" class="md-nav__link">
    WebSocket
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fluent_1" class="md-nav__link">
    Fluent
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crypto" class="md-nav__link">
    Crypto
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queues" class="md-nav__link">
    Queues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validation" class="md-nav__link">
    Validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auth" class="md-nav__link">
    Auth
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stripe" class="md-nav__link">
    Stripe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mailgun" class="md-nav__link">
    Mailgun
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leaf" class="md-nav__link">
    Leaf
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/swiftclub/vapor-docs/edit/master/docs/upgrading.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="upgrading-to-40">Upgrading to 4.0<a class="headerlink" href="#upgrading-to-40" title="Permanent link">&para;</a></h1>
<p>This guide shows you how to upgrade an existing Vapor 3.x project to 4.0. This guide attempts to cover all of Vapor's official packages as well as some commonly used providers. If you notice anything missing, <a href="https://discord.gg/vapor">Vapor's team chat</a> is a great place to ask for help. Issues and pull requests are also appreciated.</p>
<h2 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h2>
<p>To use Vapor 4, you will need Xcode 11.4 and macOS 10.15 or greater.</p>
<p>The Install section of the docs goes over installing dependencies.</p>
<h2 id="packageswift">Package.swift<a class="headerlink" href="#packageswift" title="Permanent link">&para;</a></h2>
<p>The first step to upgrading to Vapor 4 is to update your package's dependencies. Below is an example of an upgraded Package.swift file. You can also check out the updated <a href="https://github.com/vapor/template/blob/master/Package.swift">template Package.swift</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">-// swift-tools-version:4.0</span>
<span class="gi">+// swift-tools-version:5.2</span>
 import PackageDescription

 let package = Package(
     name: &quot;api&quot;,
<span class="gi">+    platforms: [</span>
<span class="gi">+        .macOS(.v10_15),</span>
<span class="gi">+    ],</span>
     dependencies: [
<span class="gd">-        .package(url: &quot;https://github.com/vapor/fluent-postgresql.git&quot;, from: &quot;1.0.0&quot;),</span>
<span class="gi">+        .package(url: &quot;https://github.com/vapor/fluent.git&quot;, from: &quot;4.0.0-rc&quot;),</span>
<span class="gi">+        .package(url: &quot;https://github.com/vapor/fluent-postgres-driver.git&quot;, from: &quot;2.0.0-rc&quot;),</span>
<span class="gd">-        .package(url: &quot;https://github.com/vapor/jwt.git&quot;, from: &quot;3.0.0&quot;),</span>
<span class="gi">+        .package(url: &quot;https://github.com/vapor/jwt.git&quot;, from: &quot;4.0.0-rc&quot;),</span>
<span class="gd">-        .package(url: &quot;https://github.com/vapor/vapor.git&quot;, from: &quot;3.0.0&quot;),</span>
<span class="gi">+        .package(url: &quot;https://github.com/vapor/vapor.git&quot;, from: &quot;4.0.0-rc&quot;),</span>
     ],
     targets: [
         .target(name: &quot;App&quot;, dependencies: [
<span class="gd">-            &quot;FluentPostgreSQL&quot;, </span>
<span class="gi">+            .product(name: &quot;Fluent&quot;, package: &quot;fluent&quot;),</span>
<span class="gi">+            .product(name: &quot;FluentPostgresDriver&quot;, package: &quot;fluent-postgres-driver&quot;),</span>
<span class="gd">-            &quot;Vapor&quot;, </span>
<span class="gi">+            .product(name: &quot;Vapor&quot;, package: &quot;vapor&quot;),</span>
<span class="gd">-            &quot;JWT&quot;, </span>
<span class="gi">+            .product(name: &quot;JWT&quot;, package: &quot;jwt&quot;),</span>
         ]),
<span class="gd">-        .target(name: &quot;Run&quot;, dependencies: [&quot;App&quot;]),</span>
<span class="gd">-        .testTarget(name: &quot;AppTests&quot;, dependencies: [&quot;App&quot;])</span>
<span class="gi">+        .target(name: &quot;Run&quot;, dependencies: [</span>
<span class="gi">+            .target(name: &quot;App&quot;),</span>
<span class="gi">+        ]),</span>
<span class="gi">+        .testTarget(name: &quot;AppTests&quot;, dependencies: [</span>
<span class="gi">+            .target(name: &quot;App&quot;),</span>
<span class="gi">+        ])</span>
     ]
 )
</code></pre></div>


<p>All packages that have been upgraded for Vapor 4 will have their major version number incremented by one.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code>-rc</code> pre-release identifier is used since Vapor 4 has not been officially released yet.</p>
</div>
<h3 id="old-packages">Old Packages<a class="headerlink" href="#old-packages" title="Permanent link">&para;</a></h3>
<p>Some packages may not be upgraded yet. If you encounter any, file an issue to let the author know. </p>
<p>Some Vapor 3 packages have been deprecated, such as:</p>
<ul>
<li><code>vapor/auth</code>: Now included in Vapor.</li>
<li><code>vapor/core</code>: Absorbed into several modules. </li>
<li><code>vapor/crypto</code>: Replaced by SwiftCrypto.</li>
<li><code>vapor/multipart</code>: Now included in Vapor.</li>
<li><code>vapor/url-encoded-form</code>: Now included in Vapor.</li>
<li><code>vapor-community/vapor-ext</code>: Now included in Vapor.</li>
<li><code>vapor-community/pagination</code>: Now part of Fluent.</li>
<li><code>IBM-Swift/LoggerAPI</code>: Replaced by SwiftLogging.</li>
</ul>
<h3 id="fluent">Fluent<a class="headerlink" href="#fluent" title="Permanent link">&para;</a></h3>
<p><code>vapor/fluent</code> must now be added as a separate dependency to your dependencies list and targets. All database-specific packages have been suffixed with <code>-driver</code> to make the requirement on <code>vapor/fluent</code> clear.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- .package(url: &quot;https://github.com/vapor/fluent-postgresql.git&quot;, from: &quot;1.0.0&quot;),</span>
<span class="gi">+ .package(url: &quot;https://github.com/vapor/fluent.git&quot;, from: &quot;4.0.0-rc&quot;),</span>
<span class="gi">+ .package(url: &quot;https://github.com/vapor/fluent-postgres-driver.git&quot;, from: &quot;2.0.0-rc&quot;),</span>
</code></pre></div>


<h3 id="platforms">Platforms<a class="headerlink" href="#platforms" title="Permanent link">&para;</a></h3>
<p>Vapor's package manifests now explicitly support macOS 10.15 and greater. This means your package will also need to specify platform support. </p>
<div class="codehilite"><pre><span></span><code><span class="gi">+ platforms: [</span>
<span class="gi">+     .macOS(.v10_15),</span>
<span class="gi">+ ],</span>
</code></pre></div>


<p>Vapor may add additional supported platforms in the future. Your package may support any subset of these platforms as long as the version number is equal or greater to Vapor's minimum version requirements. </p>
<h3 id="xcode">Xcode<a class="headerlink" href="#xcode" title="Permanent link">&para;</a></h3>
<p>Vapor 4 utilizies Xcode 11's native SPM support. This means you will no longer need to generate <code>.xcodeproj</code> files. Opening your project's folder in Xcode will automatically recognize SPM and pull in dependencies. </p>
<p>You can open your project natively in Xcode using <code>vapor-beta xcode</code> or <code>open Package.swift</code>. </p>
<p>Once you've updated Package.swift, you may need to close Xcode and clear the following folders from the root directory:</p>
<ul>
<li><code>Package.resolved</code></li>
<li><code>.build</code></li>
<li><code>.swiftpm</code></li>
<li><code>*.xcodeproj</code></li>
</ul>
<p>Once your updated packages have resolved successfully you should see compiler errors--probably quite a few. Don't worry! We'll show you how to fix them.</p>
<h2 id="run">Run<a class="headerlink" href="#run" title="Permanent link">&para;</a></h2>
<p>The first order of business is to update your Run module's <code>main.swift</code> file to the new format.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">App</span>
<span class="kd">import</span> <span class="nc">Vapor</span>

<span class="kd">var</span> <span class="nv">env</span> <span class="p">=</span> <span class="k">try</span> <span class="n">Environment</span><span class="p">.</span><span class="n">detect</span><span class="p">()</span>
<span class="k">try</span> <span class="n">LoggingSystem</span><span class="p">.</span><span class="n">bootstrap</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">env</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">app</span> <span class="p">=</span> <span class="n">Application</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="k">defer</span> <span class="p">{</span> <span class="n">app</span><span class="p">.</span><span class="n">shutdown</span><span class="p">()</span> <span class="p">}</span>
<span class="k">try</span> <span class="n">configure</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">try</span> <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>


<p>The <code>main.swift</code> file's contents replace the App module's <code>app.swift</code>, so you can delete that file.</p>
<h2 id="app">App<a class="headerlink" href="#app" title="Permanent link">&para;</a></h2>
<p>Let's take a look at how to update the basic App module structure.</p>
<h3 id="configureswift">configure.swift<a class="headerlink" href="#configureswift" title="Permanent link">&para;</a></h3>
<p>The <code>configure</code> method should be changed to accept an instance of <code>Application</code>. </p>
<div class="codehilite"><pre><span></span><code><span class="gd">- public func configure(_ config: inout Config, _ env: inout Environment, _ services: inout Services) throws</span>
<span class="gi">+ public func configure(_ app: Application) throws</span>
</code></pre></div>


<p>Below is an example of an updated configure method.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">Fluent</span>
<span class="kd">import</span> <span class="nc">FluentSQLiteDriver</span>
<span class="kd">import</span> <span class="nc">Vapor</span>

<span class="c1">// Called before your application initializes.</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">configure</span><span class="p">(</span><span class="kc">_</span> <span class="n">app</span><span class="p">:</span> <span class="n">Application</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
    <span class="c1">// Serves files from `Public/` directory</span>
    <span class="c1">// app.middleware.use(FileMiddleware(publicDirectory: app.directory.publicDirectory))</span>
    <span class="c1">// Configure SQLite database</span>
    <span class="n">app</span><span class="p">.</span><span class="n">databases</span><span class="p">.</span><span class="n">use</span><span class="p">(.</span><span class="n">sqlite</span><span class="p">(.</span><span class="n">file</span><span class="p">(</span><span class="s">&quot;db.sqlite&quot;</span><span class="p">)),</span> <span class="k">as</span><span class="p">:</span> <span class="p">.</span><span class="n">sqlite</span><span class="p">)</span>

    <span class="c1">// Configure migrations</span>
    <span class="n">app</span><span class="p">.</span><span class="n">migrations</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CreateTodo</span><span class="p">())</span>

    <span class="k">try</span> <span class="n">routes</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>


<p>Syntax changes for configuring things like routing, middleware, fluent, and more are mentioned below.</p>
<h3 id="bootswift">boot.swift<a class="headerlink" href="#bootswift" title="Permanent link">&para;</a></h3>
<p><code>boot</code>'s contents can be placed in the <code>configure</code> method since it now accepts the application instance.</p>
<h3 id="routesswift">routes.swift<a class="headerlink" href="#routesswift" title="Permanent link">&para;</a></h3>
<p>The <code>routes</code> method should be changed to accept an instance of <code>Application</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- public func routes(_ router: Router, _ container: Container) throws</span>
<span class="gi">+ public func routes(_ app: Application) throws</span>
</code></pre></div>


<p>More information on changes to routing syntax are mentioned below.</p>
<h2 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h2>
<p>Vapor 4's services APIs have been simplified to make it easier for you to discover and use services. Services are now exposed as methods and properties on <code>Application</code> and <code>Request</code> which allows the compiler to help you use them. </p>
<p>To understand this better, let's take a look at a few examples.</p>
<div class="codehilite"><pre><span></span><code>// Change the server&#39;s default port to 8281
<span class="gd">- services.register { container -&gt; NIOServerConfig in</span>
<span class="gd">-     return .default(port: 8281)</span>
<span class="gd">- }</span>
<span class="gi">+ app.server.configuration.port = 8281</span>
</code></pre></div>


<p>Instead of registering a <code>NIOServerConfig</code> to services, server configuration is now exposed as simple properties on Application that can be overridden. </p>
<div class="codehilite"><pre><span></span><code>// Register cors middleware
let corsConfiguration = CORSMiddleware.Configuration(
    allowedOrigin: .all,
    allowedMethods: [.POST, .GET, .PATCH, .PUT, .DELETE, .OPTIONS]
)
let corsMiddleware = CORSMiddleware(configuration: corsConfiguration)
<span class="gd">- var middlewares = MiddlewareConfig() // Create _empty_ middleware config</span>
<span class="gd">- middlewares.use(corsMiddleware)</span>
<span class="gd">- services.register(middlewares)</span>
<span class="gi">+ app.middleware.use(corsMiddleware)</span>
</code></pre></div>


<p>Instead of creating and registering a <code>MiddlewareConfig</code> to services, middleware are now exposed as a property on Application that can be added to.</p>
<div class="codehilite"><pre><span></span><code>// Make a request in a route handler.
<span class="gd">- try req.make(Client.self).get(&quot;https://vapor.codes&quot;)</span>
<span class="gi">+ req.client.get(&quot;https://vapor.codes&quot;)</span>
</code></pre></div>


<p>Like Application, Request also exposes services as simple properties and methods. Request-specific services should always be used when inside a route closure.</p>
<p>This new service pattern replaces the <code>Container</code>, <code>Service</code>, and <code>Config</code> types from Vapor 3. </p>
<h3 id="providers">Providers<a class="headerlink" href="#providers" title="Permanent link">&para;</a></h3>
<p>Providers are no longer required to configure third party packages. Each package instead extends Application and Request with new properties and methods for configuration.</p>
<p>Take a look at how Leaf is configured in Vapor 4.</p>
<div class="codehilite"><pre><span></span><code>// Use Leaf for view rendering. 
<span class="gd">- try services.register(LeafProvider())</span>
<span class="gd">- config.prefer(LeafRenderer.self, for: ViewRenderer.self)</span>
<span class="gi">+ app.views.use(.leaf)</span>
</code></pre></div>


<p>To configure Leaf, use the <code>app.leaf</code> property.</p>
<div class="codehilite"><pre><span></span><code>// Disable Leaf view caching.
<span class="gd">- services.register { container -&gt; LeafConfig in</span>
<span class="gd">-     return LeafConfig(tags: ..., viewsDir: ..., shouldCache: false)</span>
<span class="gd">- }</span>
<span class="gi">+ app.leaf.cache.isEnabled = false</span>
</code></pre></div>


<h3 id="environment">Environment<a class="headerlink" href="#environment" title="Permanent link">&para;</a></h3>
<p>The current environment (production, development, etc) can be accessed via <code>app.environment</code>. </p>
<h3 id="custom-services">Custom Services<a class="headerlink" href="#custom-services" title="Permanent link">&para;</a></h3>
<p>Custom services conforming to the <code>Service</code> protocol and registered to the container in Vapor 3 can be now be expressed as extensions to either Application or Request.</p>
<div class="codehilite"><pre><span></span><code>struct MyAPI {
    let client: Client
    func foo() { ... }
}
<span class="gd">- extension MyAPI: Service { }</span>
<span class="gd">- services.register { container -&gt; MyAPI in</span>
<span class="gd">-     return try MyAPI(client: container.make())</span>
<span class="gd">- }</span>
<span class="gi">+ extension Request {</span>
<span class="gi">+     var myAPI: MyAPI { </span>
<span class="gi">+         .init(client: self.client)</span>
<span class="gi">+     }</span>
<span class="gi">+ }</span>
</code></pre></div>


<p>This service can then be accessed using the extension instead of <code>make</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- try req.make(MyAPI.self).foo()</span>
<span class="gi">+ req.myAPI.foo()</span>
</code></pre></div>


<h3 id="custom-providers">Custom Providers<a class="headerlink" href="#custom-providers" title="Permanent link">&para;</a></h3>
<p>Most custom services can be implemented using extensions as shown in the previous section. However, some advanced providers may need to hook into the application lifecycle or use stored properties.</p>
<p>Application's new <code>Lifecycle</code> helper can be used to register lifecycle handlers.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">PrintHello</span><span class="p">:</span> <span class="n">LifecycleHandler</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">willBoot</span><span class="p">(</span><span class="kc">_</span> <span class="n">app</span><span class="p">:</span> <span class="n">Application</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Hello!&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">app</span><span class="p">.</span><span class="n">lifecycle</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">PrintHello</span><span class="p">())</span>
</code></pre></div>


<p>To store values on Application, you case use the new <code>Storage</code> helper. </p>
<div class="codehilite"><pre><span></span><code><span class="kd">struct</span> <span class="nc">MyNumber</span><span class="p">:</span> <span class="n">StorageKey</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">Value</span> <span class="p">=</span> <span class="nb">Int</span>
<span class="p">}</span>
<span class="n">app</span><span class="p">.</span><span class="n">storage</span><span class="p">[</span><span class="n">MyNumber</span><span class="p">.</span><span class="kc">self</span><span class="p">]</span> <span class="p">=</span> <span class="mi">5</span>
<span class="bp">print</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">storage</span><span class="p">[</span><span class="n">MyNumber</span><span class="p">.</span><span class="kc">self</span><span class="p">])</span> <span class="c1">// 5</span>
</code></pre></div>


<p>Accessing <code>app.storage</code> can be wrapped in a settable computed property to create a concise API.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">extension</span> <span class="nc">Application</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">myNumber</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span> <span class="p">{</span>
        <span class="kr">get</span> <span class="p">{</span> <span class="kc">self</span><span class="p">.</span><span class="n">storage</span><span class="p">[</span><span class="n">MyNumber</span><span class="p">.</span><span class="kc">self</span><span class="p">]</span> <span class="p">}</span>
        <span class="kr">set</span> <span class="p">{</span> <span class="kc">self</span><span class="p">.</span><span class="n">storage</span><span class="p">[</span><span class="n">MyNumber</span><span class="p">.</span><span class="kc">self</span><span class="p">]</span> <span class="p">=</span> <span class="n">newValue</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">app</span><span class="p">.</span><span class="n">myNumber</span> <span class="p">=</span> <span class="mi">42</span>
<span class="bp">print</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">myNumber</span><span class="p">)</span> <span class="c1">// 42</span>
</code></pre></div>


<p>Both Application and Request also have <code>userInfo</code> dictionaries for storing any data you may need.</p>
<h2 id="nio">NIO<a class="headerlink" href="#nio" title="Permanent link">&para;</a></h2>
<p>Vapor 4 now exposes SwiftNIO's async APIs directly and does not attempt to overload methods like <code>map</code> and <code>flatMap</code> or alias types like <code>EventLoopFuture</code>. Vapor 3 provided overloads and aliases for backward compatibility with early beta versions that were released before SwiftNIO existed. These have been removed to reduce confusion with other SwiftNIO compatible packages and better follow SwiftNIO's best practice recommendations. </p>
<h3 id="async-naming-changes">Async naming changes<a class="headerlink" href="#async-naming-changes" title="Permanent link">&para;</a></h3>
<p>The most obvious change is that the <code>Future</code> typealias for <code>EventLoopFuture</code> has been removed. This can be fixed fairly easily with a find and replace.</p>
<p>Furthermore, NIO does not support the <code>to:</code> labels that Vapor 3 added. Given Swift 5.2's improved type inference, <code>to:</code> is less necessary now anyway.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- futureA.map(to: String.self) { ... }</span>
<span class="gi">+ futureA.map { ... }</span>
</code></pre></div>


<p>Methods prefixed with <code>new</code>, like <code>newPromise</code> have been changed to <code>make</code> to better suit Swift style.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- let promise = eventLoop.newPromise(String.self)</span>
<span class="gi">+ let promise = eventLoop.makePromise(of: String.self)</span>
</code></pre></div>


<p><code>catchMap</code> is no longer available, but NIO's methods like <code>mapError</code> and <code>flatMapErrorThrowing</code> will work instead. </p>
<p>Vapor 3's global <code>flatMap</code> method for combining multiple futures is no longer available. This can be replaced by using NIO's <code>and</code> method to combine many futures together. </p>
<div class="codehilite"><pre><span></span><code><span class="gd">- flatMap(futureA, futureB) { a, b in </span>
<span class="gi">+ futureA.and(futureB).flatMap { (a, b) in</span>
    // Do something with a and b.
}
</code></pre></div>


<h3 id="bytebuffer">ByteBuffer<a class="headerlink" href="#bytebuffer" title="Permanent link">&para;</a></h3>
<p>Many methods and properties that previously used <code>Data</code> now use NIO's <code>ByteBuffer</code>. This type is a more powerful and performant byte storage type. You can read more about its API in <a href="https://apple.github.io/swift-nio/docs/current/NIO/Structs/ByteBuffer.html">SwiftNIO's ByteBuffer docs</a>.</p>
<p>To convert a <code>ByteBuffer</code> back to <code>Data</code>, use:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Data</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">readableBytesView</span><span class="p">)</span>
</code></pre></div>


<h3 id="throwing-map-flatmap">Throwing map / flatMap<a class="headerlink" href="#throwing-map-flatmap" title="Permanent link">&para;</a></h3>
<p>The most difficult change is that <code>map</code> and <code>flatMap</code> can no longer throw. <code>map</code> has a throwing version named (somewhat confusingly) <code>flatMapThrowing</code>. <code>flatMap</code> however has no throwing counterpart. This may require you to restructure some asynchronous code. </p>
<p>Maps that do <em>not</em> throw should continue to work fine.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Non-throwing map.</span>
<span class="n">futureA</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="n">a</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">b</span>
<span class="p">}</span>
</code></pre></div>


<p>Maps that <em>do</em> throw must be renamed to <code>flatMapThrowing</code>. </p>
<div class="codehilite"><pre><span></span><code><span class="gd">- futureA.map { a in</span>
<span class="gi">+ futureA.flatMapThrowing { a in</span>
    if ... {
        throw SomeError()
    } else {
        return futureB
    }
}
</code></pre></div>


<p>Flat-maps that do <em>not</em> throw should continue to work fine.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Non-throwing flatMap.</span>
<span class="n">futureA</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">a</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">futureB</span>
<span class="p">}</span>
</code></pre></div>


<p>Flat-maps that <em>do</em> throw must return a future error.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Returning a future error.</span>
<span class="n">futureA</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">a</span> <span class="k">in</span>
    <span class="k">if</span> <span class="p">...</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">eventLoop</span><span class="p">.</span><span class="n">makeFailedFuture</span><span class="p">(</span><span class="n">SomeError</span><span class="p">())</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">futureB</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>When calling methods that throw, the error can be caught in a do / catch and returned as a future.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Returning a caught error as a future.</span>
<span class="n">futureA</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">a</span> <span class="k">in</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">doSomething</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">futureB</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">eventLoop</span><span class="p">.</span><span class="n">makeFailedFuture</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Throwing method calls can also be refactored into a <code>flatMapThrowing</code> and chained using tuples.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Refactored throwing method into flatMapThrowing with tuple-chaining.</span>
<span class="n">futureA</span><span class="p">.</span><span class="n">flatMapThrowing</span> <span class="p">{</span> <span class="n">a</span> <span class="k">in</span>
    <span class="k">try</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">doSomeThing</span><span class="p">())</span>
<span class="p">}.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="c1">// result is the value of doSomething.</span>
    <span class="k">return</span> <span class="n">futureB</span>
<span class="p">}</span>
</code></pre></div>


<h2 id="routing">Routing<a class="headerlink" href="#routing" title="Permanent link">&para;</a></h2>
<p>Routes are now registered directly to Application. </p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="k">in</span>
    <span class="k">return</span> <span class="s">&quot;Hello, world&quot;</span>
<span class="p">}</span>
</code></pre></div>


<p>This means you no longer need to register a router to services. Simply pass the application to your <code>routes</code> method and start adding routes. All of the methods available on <code>RoutesBuilder</code> are available on <code>Application</code>. </p>
<h3 id="synchronous-content">Synchronous Content<a class="headerlink" href="#synchronous-content" title="Permanent link">&para;</a></h3>
<p>Decoding request content is now synchronous.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span> <span class="nv">payload</span> <span class="p">=</span> <span class="k">try</span> <span class="n">req</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">MyPayload</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
<span class="bp">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="c1">// MyPayload</span>
</code></pre></div>


<p>This behavior can be overridden by register routes using the <code>.stream</code> body collection strategy. </p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">on</span><span class="p">(.</span><span class="n">POST</span><span class="p">,</span> <span class="s">&quot;streaming&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="p">.</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span> <span class="k">in</span>
    <span class="c1">// Request body is now asynchronous.</span>
    <span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">collect</span><span class="p">().</span><span class="bp">map</span> <span class="p">{</span> <span class="n">buffer</span> <span class="k">in</span>
        <span class="n">HTTPStatus</span><span class="p">.</span><span class="n">ok</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3 id="comma-separated-paths">Comma-separated paths<a class="headerlink" href="#comma-separated-paths" title="Permanent link">&para;</a></h3>
<p>Paths must now be comma separated and not contain <code>/</code> for consistency. </p>
<div class="codehilite"><pre><span></span><code><span class="gd">- router.get(&quot;v1/users/&quot;, &quot;posts&quot;, &quot;/comments&quot;) { req in </span>
<span class="gi">+ app.get(&quot;v1&quot;, &quot;users&quot;, &quot;posts&quot;, &quot;comments&quot;) { req in</span>
    // Handle request.
}
</code></pre></div>


<h3 id="route-parameters">Route parameters<a class="headerlink" href="#route-parameters" title="Permanent link">&para;</a></h3>
<p>The <code>Parameter</code> protocol has been removed in favor of explicitly named parameters. This prevents issues with duplicate parameters and un-ordered fetching of parameters in middleware and route handlers.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- router.get(&quot;planets&quot;, String.parameter) { req in </span>
<span class="gd">-     let id = req.parameters.next(String.self)</span>
<span class="gi">+ app.get(&quot;planets&quot;, &quot;:id&quot;) { req in</span>
<span class="gi">+     let id = req.parameters.get(&quot;id&quot;)</span>
      return &quot;Planet id: \(id)&quot;
  }
</code></pre></div>


<p>Route parameter usage with models is mentioned in the Fluent section.</p>
<h2 id="middleware">Middleware<a class="headerlink" href="#middleware" title="Permanent link">&para;</a></h2>
<p><code>MiddlewareConfig</code> has been renamed to <code>MiddlewareConfiguration</code> and is now a property on Application. You can add middleware to your app using <code>app.middleware</code>. </p>
<div class="codehilite"><pre><span></span><code>let corsMiddleware = CORSMiddleware(configuration: ...)
<span class="gd">- var middleware = MiddlewareConfig()</span>
<span class="gd">- middleware.use(corsMiddleware)</span>
<span class="gi">+ app.middleware.use(corsMiddleware)</span>
<span class="gd">- services.register(middlewares)</span>
</code></pre></div>


<p>Middleware can no longer be registered by type name. Initialize the middleware first before registering.</p>
<div class="codehilite"><pre><span></span><code><span class="gd">- middleware.use(ErrorMiddleware.self)</span>
<span class="gi">+ app.middleware.use(ErrorMiddleware.default(environment: app.environment))</span>
</code></pre></div>


<p>To remove all default middleware, set <code>app.middleware</code> to an empty config using:</p>
<div class="codehilite"><pre><span></span><code><span class="n">app</span><span class="p">.</span><span class="n">middleware</span> <span class="p">=</span> <span class="p">.</span><span class="kd">init</span><span class="p">()</span>
</code></pre></div>


<h2 id="http">HTTP<a class="headerlink" href="#http" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="websocket">WebSocket<a class="headerlink" href="#websocket" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="fluent_1">Fluent<a class="headerlink" href="#fluent_1" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="crypto">Crypto<a class="headerlink" href="#crypto" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="queues">Queues<a class="headerlink" href="#queues" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="validation">Validation<a class="headerlink" href="#validation" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="auth">Auth<a class="headerlink" href="#auth" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="stripe">Stripe<a class="headerlink" href="#stripe" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="mailgun">Mailgun<a class="headerlink" href="#mailgun" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
<h2 id="leaf">Leaf<a class="headerlink" href="#leaf" title="Permanent link">&para;</a></h2>
<p>Coming soon.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../version/4_0/" title="4.0" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                4.0
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.36cbf620.min.js"></script>
      <script src="../assets/javascripts/bundle.00c583dd.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.7f7c8775.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>